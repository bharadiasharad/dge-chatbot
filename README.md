# RAG Chat Storage Microservice

A production-ready backend microservice for storing chat histories generated by a RAG (Retrieval-Augmented Generation) based chatbot system. Built with NestJS, PostgreSQL, Redis, and Ollama.

## 🚀 Features

### Core Functionality
- **Chat Session Management**: Create, rename, favorite, and delete chat sessions
- **Message Storage**: Save messages with sender, content, and optional context
- **RAG Integration**: Document-based retrieval and generation
- **Document Management**: Upload, process, and manage documents (TXT, PDF)
- **Vector Search**: PostgreSQL with pgvector for similarity search
- **LLM Integration**: Ollama with phi3:mini for response generation (configurable)

### Technical Features
- **API Key Authentication**: Secure all endpoints
- **Rate Limiting**: Prevent API abuse
- **Centralized Logging**: Comprehensive logging system
- **Global Error Handling**: Consistent error responses
- **Swagger Documentation**: Auto-generated API docs
- **Health Checks**: Monitor service health
- **Dockerized**: Complete containerized setup
- **CORS Configuration**: Security headers
- **Pagination Support**: Efficient data retrieval

## 🏗️ Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   NestJS App    │    │   PostgreSQL    │    │     Redis       │
│   (Port 8000)   │◄──►│   (Port 5432)   │    │   (Port 6379)   │
│                 │    │   + pgvector    │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│    Ollama       │    │    pgAdmin      │    │  Document       │
│  (Port 11434)   │    │   (Port 5050)   │    │   Storage      │
│  phi3:mini      │    │                 │    │   (Volume)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 📋 API Endpoints

### Authentication
- `POST /api/v1/auth/register` - Register new user
- `POST /api/v1/auth/login` - User login

### Sessions
- `GET /api/v1/sessions` - List user sessions
- `POST /api/v1/sessions` - Create new session
- `GET /api/v1/sessions/:id` - Get session details
- `PATCH /api/v1/sessions/:id` - Update session
- `DELETE /api/v1/sessions/:id` - Delete session
- `POST /api/v1/sessions/:id/chat` - **RAG Chat endpoint**

### RAG
- `POST /api/v1/rag/chat` - Chat with uploaded documents using RAG
- `POST /api/v1/rag/query` - Query documents for relevant information

### Messages
- `GET /api/v1/sessions/:id/messages` - Get session messages
- `POST /api/v1/sessions/:id/messages` - Add message to session

### Documents (RAG)
- `POST /api/v1/documents/upload` - Upload document
- `GET /api/v1/documents` - List all documents
- `GET /api/v1/documents/:id` - Get document details
- `DELETE /api/v1/documents/:id` - Delete document

### Health
- `GET /api/v1/health` - Health check
- `GET /api/v1/health/live` - Liveness probe
- `GET /api/v1/health/ready` - Readiness probe

## 🛠️ Setup & Installation

### Prerequisites
- Docker and Docker Compose
- Node.js 18+ (for local development)

### Development Setup

1. **Clone and navigate to the project:**
   ```bash
   cd assignment
   ```

2. **Set up environment variables:**
   ```bash
   cp env.example .env
   # Edit .env with your configuration
   ```

3. **Start all services:**
   ```bash
   docker-compose up -d
   ```

4. **Pull the LLM model (first time only):**
   ```bash
   # Wait for Ollama to start, then pull the model
   docker-compose exec ollama ollama pull phi3:mini
   ```

5. **Access the services:**
   - **API**: http://localhost:8000
   - **Swagger Docs**: http://localhost:8000/api/docs
   - **pgAdmin**: http://localhost:5050
   - **Ollama**: http://localhost:11434

### Production Setup

1. **Set up production environment:**
   ```bash
   cp env.production.example .env.production
   # Edit .env.production with your production values
   ```

2. **Start production services:**
   ```bash
   docker-compose -f docker-compose.prod.yml up -d
   ```

3. **For debugging in production (optional):**
   ```bash
   docker-compose -f docker-compose.prod.yml --profile debug up -d
   ```

### Environment Variables

The application supports extensive configuration through environment variables. See `env.example` for all available options:

#### Key Configuration Categories:
- **Application**: Port, host, environment
- **Database**: PostgreSQL with pgvector settings
- **Redis**: Caching and session storage
- **JWT**: Authentication tokens
- **API Key**: Security authentication
- **Ollama**: LLM configuration
- **Rate Limiting**: API protection
- **CORS**: Cross-origin settings
- **Security**: Helmet, compression
- **Health Checks**: Monitoring
- **File Upload**: Document processing
- **Vector Storage**: pgvector settings
- **RAG**: Retrieval and generation
- **Monitoring**: Metrics and logging
- **Development**: Swagger, debugging

#### Production Security Checklist:
- [ ] Change all default secrets (JWT_SECRET, API_KEY, etc.)
- [ ] Set DATABASE_SSL=true
- [ ] Set DATABASE_SYNCHRONIZE=false
- [ ] Set LOG_LEVEL=info
- [ ] Set SWAGGER_ENABLED=false
- [ ] Configure proper CORS_ORIGIN
- [ ] Set strong database passwords
- [ ] Configure Redis password
- [ ] Set up proper SSL/TLS certificates
- [ ] Configure backup strategies

## 🧪 Testing

### Run the test script:
```bash
chmod +x test-rag-functionality.sh
./test-rag-functionality.sh
```

### Manual Testing

1. **Upload a document:**
   ```bash
   curl -X POST "http://localhost:8000/api/v1/documents/upload" \
     -H "X-API-Key: your-super-secret-api-key-change-this-in-production" \
     -F "file=@your-document.txt"
   ```

2. **Create a chat session:**
   ```bash
   curl -X POST "http://localhost:8000/api/v1/sessions" \
     -H "X-API-Key: your-super-secret-api-key-change-this-in-production" \
     -H "Authorization: Bearer YOUR_JWT_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"title": "My RAG Session"}'
   ```

3. **Send a RAG chat message:**
   ```bash
   curl -X POST "http://localhost:8000/api/v1/rag/chat" \
     -H "X-API-Key: your-super-secret-api-key-change-this-in-production" \
     -H "Authorization: Bearer YOUR_JWT_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"message": "What can you tell me about the documents?"}'
   ```

## 🔧 Development

### Local Development
```bash
# Install dependencies
npm install

# Run in development mode
npm run start:dev

# Build for production
npm run build
```

### Docker Development
```bash
# Rebuild with no cache
docker-compose build --no-cache

# View logs
docker-compose logs -f app

# Access container shell
docker-compose exec app sh
```

## 📊 Database Schema

### Core Tables
- `users` - User accounts
- `sessions` - Chat sessions
- `messages` - Chat messages
- `documents` - Uploaded documents (RAG)
- `document_chunks` - Document chunks with embeddings (RAG)

### Vector Storage
- Uses PostgreSQL with pgvector extension
- Embeddings stored as JSON strings
- Similarity search for document retrieval

## 🔒 Security

- **API Key Authentication**: All endpoints protected
- **JWT Tokens**: User session management
- **Rate Limiting**: Prevents abuse
- **Input Validation**: Comprehensive validation
- **CORS**: Configured for security
- **Error Handling**: No sensitive data exposure

## 📈 Performance

- **Caching**: Redis for session data
- **Pagination**: Efficient data retrieval
- **Connection Pooling**: Database optimization
- **Async Processing**: Non-blocking operations
- **Vector Indexing**: Fast similarity search

## 🚀 Production Deployment

### Docker Compose
```bash
# Production build
docker-compose -f docker-compose.yml up -d

# With custom environment
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

### Environment Configuration
- Set strong passwords and secrets
- Configure proper database credentials
- Set up SSL/TLS certificates
- Configure backup strategies

## 📝 API Documentation

Access the interactive Swagger documentation at:
http://localhost:8000/api/docs

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Submit a pull request

## 📄 License

This project is licensed under the MIT License.

---

## 🎯 **RAG Implementation Status: ✅ COMPLETE**

All RAG features have been successfully implemented and are working:

- ✅ **Document Upload & Processing**: TXT and PDF support
- ✅ **Vector Storage**: PostgreSQL with pgvector
- ✅ **LLM Integration**: Ollama with phi3:mini
- ✅ **RAG Pipeline**: Retrieval + Generation
- ✅ **API Endpoints**: All RAG endpoints functional
- ✅ **Containerization**: All services containerized
- ✅ **Authentication & Security**: Fully secured
- ✅ **Error Handling**: Comprehensive error management

**Ready for production use! 🚀**